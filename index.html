<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title> Share Flex message (เวอร์ชั่นปันสุข) </title>
    <link rel="shortcut icon" href="https://developers.line.biz/console/favicon.ico">
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
      integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
      crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Kanit|Niramit|Pattaya|Prompt|Sarabun|Sriracha|Questrial|Mitr|Mali|Itim' rel='stylesheet' type='text/css'>
    <script src="https://kit.fontawesome.com/ad42651166.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"/>

    <link href="https://cdn.jsdelivr.net/gh/projectwebpp/npn/mdb.min.css" rel="stylesheet">
    <link href="/Flex-to-html-Share/style.css" rel="stylesheet" type="text/css" />
    <link href="/Flex-to-html-Share/flex2html.css" rel="stylesheet" type="text/css" />
    <script src="/Flex-to-html-Share/flex2html.js"></script>
  </head>
  <body onload="myFunction()">
    <div id="text"></div>
    <div class="row justify-content-center">
      <div class="col text-center ">
        <div class="p-3 mb-2 bg-primary text-white fixed-top">
          <i class="fa fa-share" aria-hidden="true"></i> ระบบส่งข่าวสารผ่านไลน์ ด้วย FlexMessage (เวอร์ชั่นปันสุข)
        </div>
        <br><br>
        <h3 class="text-primary fw-bolder"></h3><br>
        <img id="pictureUrl" class="img-circle" alt="Cinque Terre" width="50" height="50"> 
        <p id="userId"></p>
        <center><p id="displayName"></p></center>
        <p id="statusMessage"></p>
        <p id="getDecodedIDToken"></p>
        <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
        <script>
          function runApp() {
            liff.getProfile().then(profile => {
              document.getElementById("pictureUrl").src = profile.pictureUrl;
              document.getElementById("displayName").innerHTML = '<b>สวัสดี:</b> ' + profile.displayName;
            }).catch(err => console.error(err));
          }

          liff.init({ liffId: "2005615503-drRxpq86" }, () => {
            if (liff.isLoggedIn()) {
              runApp();
            } else {
              liff.login();
            }
          }, err => console.error(err.code, error.message));
        </script>
      </div>
    </div>

    <script>
      function process() {
        let input = document.getElementById("flexjson").value;
        let altText = document.getElementById("altText").value;
        let output;
        let isFlex = false;

        try {
          let flex = JSON.parse(input);
          output = flex;
          isFlex = true;
        } catch (e) {
          output = input;
          isFlex = false;
        }

        sendTemplatFlex(output, isFlex, altText);
      }
    </script>

    <script>
      (async () => {
        let liffId = "2005615503-drRxpq86"; 
        await liff.init({ liffId: liffId });
        liff.ready.then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          }
        });
      })();

      function setCredit(message) {
        if (message.footer?.contents?.length > 0) {
          let length = message.footer?.contents.length;
          if (message.footer?.contents[length - 1]?.type == "spacer") {
            message.footer.contents.push("Developed by Ai Aekket Team");
            length++;
            message.footer.contents[length - 1] = message.footer.contents[length - 2];
            message.footer.contents[length - 2] = {
              type: "text",
              text: "Developed by Ai Aekket Team",
              weight: "bold",
              align: "center",
              size: "10px",
              decoration: "none",
              color: "#3366FF"
            };
          } else {
            message.footer?.contents.push({
              type: "text",
              text: "Developed by Ai Aekket Team",
              weight: "bold",
              align: "center",
              decoration: "none",
              size: "10px",
              color: "#3366FF",
              adjustMode: "shrink-to-fit"
            });
          }
        } else {
          message.footer = {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              {
                type: "text",
                text: "Developed by Ai Aekket Team",
                weight: "bold",
                align: "center",
                decoration: "none",
                size: "10px",
                color: "#3366FF",
                adjustMode: "shrink-to-fit"
              }
            ],
            flex: 0
          };
        }
        return message;
      }

      async function sendTemplatFlex(output, isFlex, altText) {
        method = "share";
        let message;
        if (isFlex) {
          if (output.type != "flex") {
            message = {
              type: "flex",
              altText: altText,
              contents: output
            };
            if (message.contents.type == "carousel") {
              message.contents.contents.map(bubble => setCredit(bubble));
            } else {
              message.contents = setCredit(message.contents);
            }
          } else {
            message = `${output}\n\nDeveloped by Ai Aekket Team`;
          }
        } else {
          message = {
            type: "text",
            text: `${output}\n\nDeveloped by Ai Aekket Team`
          };
        }

        liff.ready.then(() => {
          if (!liff.isInClient()) {
            if (!liff.isLoggedIn()) {
              liff.login();
            } else {
              if (liff.isApiAvailable("shareTargetPicker")) {
                liff.shareTargetPicker([message]).then(result => {
                  if (result) {
                    Swal.fire({
                      position: 'top-end',
                      icon: 'success',
                      title: 'ส่งข้อความเรียบร้อยแล้ว',
                      showConfirmButton: false,
                      timer: 1500
                    });
                    liff.closeWindow();
                  } else {
                    const [majorVer, minorVer, patchVer] = (
                      liff.getLineVersion() || ""
                    ).split(".");

                    if (minorVer === undefined) {
                      Swal.fire({
                        position: 'top-end',
                        icon: 'warning',
                        title: 'ยกเลิกการส่งข้อความเรียบร้อยแล้ว',
                        showConfirmButton: false,
                        timer: 1500
                      });
                      return;
                    }

                    if (parseInt(majorVer) >= 10 && parseInt(minorVer) >= 10 && parseInt(patchVer) > 0) {
                      Swal.fire({
                        position: 'top-end',
                        icon: 'warning',
                        title: 'ยกเลิกการส่งข้อความเรียบร้อยแล้ว',
                        showConfirmButton: false,
                        timer: 1500
                      });
                    }
                  }
                });
              }
            }
          } else {
            if (liff.isApiAvailable("shareTargetPicker")) {
              liff.shareTargetPicker([message]).then(result => {
                if (result) {
                  Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'ส่งข้อความเรียบร้อยแล้ว',
                    showConfirmButton: false,
                    timer: 1500
                  });
                  liff.closeWindow();
                } else {
                  const [majorVer, minorVer, patchVer] = (
                    liff.getLineVersion() || ""
                  ).split(".");

                  if (minorVer === undefined) {
                    Swal.fire({
                      position: 'top-end',
                      icon: 'warning',
                      title: 'ยกเลิกการส่งข้อความเรียบร้อยแล้ว',
                      showConfirmButton: false,
                      timer: 1500
                    });
                    return;
                  }

                  if (parseInt(majorVer) >= 10 && parseInt(minorVer) >= 10 && parseInt(patchVer) > 0) {
                    Swal.fire({
                      position: 'top-end',
                      icon: 'warning',
                      title: 'ยกเลิกการส่งข้อความเรียบร้อยแล้ว',
                      showConfirmButton: false,
                      timer: 1500
                    });
                  }
                }
              });
            }
          }
        });
      }
    </script>

    <div class="container mt-4">
      <div class="row justify-content-md-center">
        <div class="col-md-8">
          <div class="form-group">
            <textarea id="flexjson" class="form-control" rows="10"></textarea>
          </div>
          <div class="form-group mt-2">
            <input id="altText" type="text" class="form-control" placeholder="Alt Text">
          </div>
          <div class="form-group mt-2">
            <button id="processButton" class="btn btn-primary" onclick="process()">Process</button>
            <button type="button" class="btn btn-primary mt-2" onclick="previewFlex()">Preview Flex Message</button>
          </div>
          <div class="mt-4" id="flex1" style="background-color: #f8f9fa; padding: 20px; border-radius: 8px;"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
      integrity="sha384-IQsoLXl1PILFhosVNubq6AA1ZDXYdJ8A5HJz8N3mepe4pLvYZpJdZ7C2M4r7aApR"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
      integrity="sha384-j0P5TVWjjp6zF69ALaW3oYHeBtVwI1VOcdor0kTfHgGH7ojz4ENSmHpF8fNxkPf4"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </body>
</html>
